<!doctype html>
<html>
        <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width,initial-scale=1">
                <meta name="google" value="notranslate">
                <meta name="description" content="TurboWarp is a Scratch mod with a compiler to run projects faster, dark mode for your eyes, a bunch of addons to improve the editor, and more."/>
                <title>TurboWarp</title>
                <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
                <link rel="manifest" href="manifest.webmanifest">
                <style>
                        #splash {
        position: absolute; width: 100%; height: 100%; top: 0; left: 0;
        display: flex; align-items: center; justify-content: center;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; color: #ff4c4c;
      }
      .tw-loaded #splash, #splash-content { display: none; }
      #splash[splash-theme="dark"] { background-color: #333; color: #fff; }
      #splash-spinner:after {
        content: " "; display: block; width: 64px; height: 64px;
        border-radius: 50%; border: 6px solid; border-color: currentColor transparent currentColor transparent;
        animation: splash-spinner 1.2s linear infinite;
      }
      @keyframes splash-spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }</style>
        </head>
        <body>
                <div id="splash" aria-hidden="true">
                        <noscript>
                                <h1>Enable JavaScript</h1>
                        </noscript>
                        <div id="splash-content">
                                <div id="splash-spinner"></div>
                        </div>
                </div>

<script>
    // ğŸ’¡ ãƒ—ãƒ­ã‚­ã‚·è¨­å®š
    // Step 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ãƒ™ãƒ¼ã‚¹
    const PROXY_INFO_URL_BASE = "https://xeroxapp032.vercel.app/projects/"; 
    const originalFetch = window.fetch;

    async function getProjectDataViaProxy(projectId) {
        // 1. ğŸ”‘ Step A: ãƒ—ãƒ­ã‚­ã‚·ã‹ã‚‰ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å«ã‚€JSONã‚’å–å¾—
        console.log(`Step A: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æƒ…å ±ã‚’å«ã‚€JSONã‚’ ${PROXY_INFO_URL_BASE}${projectId} çµŒç”±ã§å–å¾—...`);
        
        // ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã® /projects/ID ã«ã‚¢ã‚¯ã‚»ã‚¹
        const tokenResponse = await originalFetch(`${PROXY_INFO_URL_BASE}${projectId}`);
        
        const tokenData = await tokenResponse.json(); 
        console.log(`tokenData:`, tokenData); 
        
        // JSONã‹ã‚‰æœ€çµ‚çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL (data_url) ã‚’æŠ½å‡º
        // ã“ã®å€¤ã¯æ—¢ã«ã€Œhttps://xeroxapp032.vercel.app/dl?data_url=...ã€ã®å½¢ã«ãªã£ã¦ã„ã‚‹ï¼
        const finalDownloadUrl = tokenData.data_url; 
        console.log(`finalDownloadUrl (from proxy):`, finalDownloadUrl); 
        
        if (!finalDownloadUrl || !finalDownloadUrl.includes('/dl?data_url=')) {
             // ã‚µãƒ¼ãƒãƒ¼ãŒæƒ³å®šå¤–ã®å€¤ã‚’è¿”ã—ãŸå ´åˆ
             throw new Error("ãƒ—ãƒ­ã‚­ã‚·ã‹ã‚‰æœ‰åŠ¹ãª 'data_url' (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL) ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
        
        // 2. ğŸ“¦ Step B: æœ€çµ‚çš„ãªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ—ãƒ­ã‚­ã‚·URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        // â­ ã“ã‚ŒãŒ /dl?data_url=... ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ç›¸å½“ã—ã¾ã™
        console.log("Step B: æœ€çµ‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è»¢é€...");

        const response = await originalFetch(finalDownloadUrl);
        const data = await response.text();

        // 3. ğŸ¯ Step C: å¿œç­”ã‚’å…ƒã® fetch ã®çµæœã¨åŒã˜å½¢å¼ã§è¿”ã™
        if (!response.ok) {
            // ãƒ—ãƒ­ã‚­ã‚·ãŒã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ãŸå ´åˆ
            throw new Error(`Proxy failed (Stage 2 - Download): ${data}`);
        }

        // å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆã‚’ Response ã«å¤‰æ›ã—ã¦è¿”ã™
        return new Response(data, {
            status: response.status,
            headers: { 'Content-Type': 'application/json' }
        });
    }

    // ğŸ’¡ Step 2: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã® fetch é–¢æ•°ã‚’ä¸Šæ›¸ãï¼ˆãƒ•ãƒƒã‚¯ï¼‰ã™ã‚‹ (æ¡ä»¶ã¯ãã®ã¾ã¾)
    window.fetch = function(resource, options) {
        const url = resource.toString();
        
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆURL: projects.scratch.mit.edu/ID ã‚’æ¤œå‡º
        if (url.includes('projects.scratch.mit.edu/')) {
            const match = url.match(/projects\.scratch\.mit\.edu\/(\d+)/);
            
            if (match && match[1]) {
                const projectId = match[1];
                console.log(`ğŸ”¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID ${projectId} ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã«ãƒ•ãƒƒã‚¯ã—ã¾ã—ãŸï¼`);
                
                // 2æ®µéšå‡¦ç†ã‚’å®Ÿè¡Œ
                return getProjectDataViaProxy(projectId); 
            }
        }

        // ãã‚Œä»¥å¤–ã®å…¨ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å…ƒã® fetch ã‚’ä½¿ã†
        return originalFetch(resource, options);
    };

</script>
                <script>
                        (function() {
        document.querySelector('#splash-content').style.display = 'block';
        
        try {var localTheme = localStorage.getItem('tw:theme');} catch (e) {}
        if (localTheme ? localTheme === 'dark' : window.matchMedia('(prefers-color-scheme: dark)').matches) document.querySelector('#splash').setAttribute('splash-theme', 'dark');
        
      })();
                </script>
                <div id="app"></div>
                <script src="js/vendors~addon-settings~credits~editor~embed~fullscreen~player.3e609736d74b93411c51.js"></script>
                <script src="js/vendors~editor~embed~fullscreen~player.36bc57ed73a40e56b640.js"></script>
                <script src="js/addon-settings~addons~editor~fullscreen~player.1af613e0edbf7211ac43.js"></script>
                <script src="js/editor~embed~fullscreen~player.9a447cb0f28a51fdb099.js"></script>
                <script src="js/player.c398a18052e43462316f.js"></script>
        </body>
</html>
